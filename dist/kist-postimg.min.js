/*! kist-postimg 0.2.0 - Load images via postpone or lazyload method. | Author: Ivan NikoliÄ‡, 2014 | License: MIT */
!function(a,b){var c="KistPostimg",d="KistPostimg",e="kist.postimg",f=[],g=function(b,c){this.element=b,this.settings=a.extend({},this.defaults,c),this.instanceId="instance"+(new Date).getTime()};a.extend(g.prototype,{init:function(){return this.dfdImageState=a.Deferred(),this.getDomRefs(),a.when(this.checkPostImgState()).done(a.proxy(this.onCheckPostImgState,this)),this},getDomRefs:function(){this.domRefs=a.extend({},this.domRefs),this.domRefs.imagesEl=a(this.element)},checkPostImgState:function(){return this.domRefs.imagesEl=this.domRefs.imagesEl.filter(function(){return Boolean(a(this).data("isPostImgAlreadySet"))===!1}),this.domRefs.imagesEl.data("isPostImgAlreadySet",!0).addClass(d),0!==this.domRefs.imagesEl.length?this.dfdImageState.resolve():this.dfdImageState.reject(),this.dfdImageState.promise()},parseImages:function(b){b.each(a.proxy(function(b,c){var d=a(c);a.loadImage(d.data("src")).done(a.proxy(this.onParsedImage,this,d))},this))},onParsedImage:function(a){a.attr("src",a.data("src")).attr("alt",a.data("alt")).removeAttr("width").removeAttr("height").addClass(d+"-is-loaded"),this.domRefs.imagesEl=this.domRefs.imagesEl.not(a)}});var h=function(a,b){g.call(this,a,b)};h.prototype=new g,a.extend(h.prototype,{constructor:h,defaults:{threshold:300,scrollTimeout:300},domRefs:{windowEl:a(b)},getDomRefs:function(){g.prototype.getDomRefs.call(this),this.settings.imagesElRemainingCount=this.domRefs.imagesEl.length},bindUiActions:function(b){return Boolean(b)===!0?(this.domRefs.windowEl.off("scroll."+this.instanceId+"."+e),void this.domRefs.windowEl.off("resize."+this.instanceId+"."+e)):(this.domRefs.windowEl.on("scroll."+this.instanceId+"."+e,a.debounce(this.settings.scrollTimeout,a.proxy(this.fetchImages,this))),void this.domRefs.windowEl.on("resize."+this.instanceId+"."+e,a.debounce(this.settings.scrollTimeout,a.proxy(this.fetchImages,this))))},onCheckPostImgState:function(){this.bindUiActions(),this.fetchImages()},fetchImages:function(){0===this.settings.imagesElRemainingCount&&this.bindUiActions("unbind"),this.parseImages(this.domRefs.imagesEl.KistInView("getElementsInView",this.settings.threshold))},onParsedImage:function(){g.prototype.onParsedImage.apply(this,arguments),this.settings.imagesElRemainingCount--}});var i=function(a,b){g.call(this,a,b)};i.prototype=new g,a.extend(i.prototype,{constructor:i,onCheckPostImgState:function(){this.fetchImages()},fetchImages:function(){this.parseImages(this.domRefs.imagesEl)}}),a[c]={instances:f,defaults:h.prototype.defaults,fetchAllImages:function(){a.each(f,function(a,b){b.fetchImages()})}},a.fn[c]=function(b,d){if("string"!==a.type(arguments[0]))throw new Error(c+": Please provide image loading method.");return"postpone"===b?f.push(new h(this,d).init()):"lazyload"===b&&f.push(new i(this).init()),this}}(jQuery,window,document);
/*! kist-postimg 0.0.0 - Load images via postpone or lazyload method. | Author: Ivan NikoliÄ‡, 2014 | License: MIT */
!function(a,b){var c={},d="KistPostimg",e="KistPostimg",f="kist.postimg",g=function(b,c){this._element=b,this.settings=a.extend({},this.defaults,c)};c.defaults={threshold:300,scrollTimeout:300,loadType:"postpone"},c.domRefs={windowEl:a(b)},c.init=function(){return this.checkPostImgStateDfd=a.Deferred(),this.getDomRefs(),a.when(this.checkPostImgState()).done(a.proxy(function(){this.bindUiActions(),this.fetchPostponedImages(),this.fetchLazyLoadedImages()},this)),this},c.getDomRefs=function(){this.domRefs=a.extend({},this.domRefs),this.domRefs.imagesEl=a(this._element)},c.bindUiActions=function(){this.domRefs.windowEl.on("scroll."+f,a.debounce(this.settings.scrollTimeout,a.proxy(this.fetchPostponedImages,this))),this.domRefs.windowEl.on("resize."+f,a.debounce(this.settings.scrollTimeout,a.proxy(this.fetchPostponedImages,this)))},c.checkPostImgState=function(){return this.domRefs.imagesEl.each(a.proxy(function(b,c){var d=a(c);Boolean(d.data("isPostImgAlreadySet"))===!1?d.data("isPostImgAlreadySet",!0):this.removeFromImageCollection(d)},this)),0!==this.domRefs.imagesEl.length?this.checkPostImgStateDfd.resolve():this.checkPostImgStateDfd.reject(),this.checkPostImgStateDfd.promise()},c.fetchPostponedImages=function(){if("postpone"===this.settings.loadType){var a=this.getVisibleImages();0!==a.length&&this.parseImages(a)}},c.fetchLazyLoadedImages=function(){"lazyload"===this.settings.loadType&&this.parseImages(this.domRefs.imagesEl)},c.parseImages=function(c){var d,f;if(d=c.filter(function(){return"undefined"!=typeof a(this).data("picture")}),f=c.filter(function(){return a(this).is("img")===!0}),0!==d.length){if(!b.hasOwnProperty("Picture"))throw new Error("Picture parser is not available.");b.Picture.parse(d.get())}else 0!==f.length&&f.each(function(b,c){var d=a(c);a.loadImage(d.data("src")).done(function(){d.attr("src",d.data("src")).attr("alt",d.data("alt")).removeAttr("width").removeAttr("height").addClass(e+"--is-loaded")})})},c.getVisibleImages=function(){var a;return a=this.domRefs.imagesEl.KistInView("getElementsInView",this.settings.threshold),this.domRefs.imagesEl=this.domRefs.imagesEl.not(a),a},c.addToImageCollection=function(b){this.domRefs.imagesEl=this.domRefs.imagesEl.add(a(b))},c.removeFromImageCollection=function(b){this.domRefs.imagesEl=this.domRefs.imagesEl.not(a(b))},a.extend(g.prototype,c),a[d]={},a[d].instances={},a[d].defaults=g.prototype.defaults,a[d].fetchAllImages=function(){for(var a in this.instances)this.instances.hasOwnProperty(a)&&(this.instances[a].fetchPostponedImages(),this.instances[a].fetchLazyLoadedImages())},a.fn[d]=function(b){return a[d].instances["instance"+(new Date).getTime()]=new g(this,b).init(),this}}(jQuery,window,document);